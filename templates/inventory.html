{% extends "base.html" %}
{% block title %}Complete Inventory{% endblock %}

{% block extra_css %}
<style>
    .inventory-card {
        transition: all 0.3s ease;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .inventory-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .status-badge {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
    
    .imei-code {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .filter-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .brand-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .brand-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .brand-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .brand-card.selected {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        transform: scale(1.05);
    }
    
    .brand-name {
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .brand-count {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    
    .brand-breakdown {
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
        opacity: 0.8;
    }
    
    .brand-stats {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #17a2b8;
    }
    
    .brand-stats .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .brand-stats .stat-item:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-boxes text-primary me-2"></i>
                    Inventory Management
                </h2>
                <div>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h4 class="mb-1">{{ inventory_items|length }}</h4>
                <p class="mb-0">Total Devices</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h4 class="mb-1">{{ inventory_items|selectattr('status', 'equalto', 'Available')|list|length }}</h4>
                <p class="mb-0">Available for Sale</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h4 class="mb-1">{{ inventory_items|selectattr('status', 'equalto', 'Sold')|list|length }}</h4>
                <p class="mb-0">Sold Devices</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h4 class="mb-1">
                    {% if session.get('profit_verified') %}
                        {% set total_profit = inventory_items|selectattr('profit')|sum(attribute='profit') %}
                        PKR {{ "{:,}".format(total_profit|float) }}
                    {% else %}
                        Protected
                    {% endif %}
                </h4>
                <p class="mb-0">Total Revenue</p>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h5 class="mb-2">
                            <i class="fas fa-filter me-2"></i>
                            Inventory Filters
                        </h5>
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-light btn-sm" onclick="filterByStatus('all')">
                                <i class="fas fa-list me-1"></i>All Items
                            </button>
                            <button class="btn btn-success btn-sm" onclick="filterByStatus('Available')">
                                <i class="fas fa-check me-1"></i>Available for Sale
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="filterByStatus('Sold')">
                                <i class="fas fa-shopping-cart me-1"></i>Sold Items
                            </button>
                            <button class="btn btn-info btn-sm" onclick="toggleBrandFilter()">
                                <i class="fas fa-tags me-1"></i>Filter by Brand
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Brand Filter Section -->
    <div class="row mb-4" id="brand-filter-section" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-tags me-2"></i>
                        Filter by Brand
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <select class="form-select" id="brand-select" onchange="filterByBrand()">
                                <option value="">All Brands</option>
                                {% set brands = inventory_items|map(attribute='brand')|unique|list %}
                                {% for brand in brands %}
                                    {% if brand %}
                                    <option value="{{ brand.name }}">{{ brand.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="brand-stats" id="brand-stats">
                                <small class="text-muted">Select a brand to view statistics</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="brand-grid" id="brand-grid">
                            {% set brand_counts = {} %}
                            {% for item in inventory_items %}
                                {% if item.brand %}
                                    {% set brand_name = item.brand.name %}
                                    {% if brand_name not in brand_counts %}
                                        {% set _ = brand_counts.update({brand_name: {'total': 0, 'available': 0, 'sold': 0}}) %}
                                    {% endif %}
                                    {% set _ = brand_counts[brand_name].update({'total': brand_counts[brand_name]['total'] + 1}) %}
                                    {% if item.status == 'Available' %}
                                        {% set _ = brand_counts[brand_name].update({'available': brand_counts[brand_name]['available'] + 1}) %}
                                    {% else %}
                                        {% set _ = brand_counts[brand_name].update({'sold': brand_counts[brand_name]['sold'] + 1}) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% for brand_name, counts in brand_counts.items() %}
                            <div class="brand-card" onclick="selectBrand('{{ brand_name }}')">
                                <div class="brand-name">{{ brand_name }}</div>
                                <div class="brand-count">{{ counts.total }} devices</div>
                                <div class="brand-breakdown">
                                    <span class="text-success">{{ counts.available }} available</span>
                                    <span class="text-danger">{{ counts.sold }} sold</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Items -->
    <div class="row" id="inventory-container">
        {% for item in inventory_items %}
        <div class="col-lg-6 col-xl-4 mb-4 inventory-item" data-status="{{ item.status }}" data-brand="{{ item.brand.name if item.brand else 'Unknown' }}">
            <div class="card inventory-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-mobile-alt me-2"></i>
                        {{ item.brand.name if item.brand else 'Unknown Brand' }}
                    </h6>
                    <span class="badge status-badge bg-{{ 'success' if item.status == 'Available' else 'danger' }}">
                        {{ item.status }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Model:</strong>
                        <span class="badge bg-info">{{ item.model.name if item.model else 'Unknown Model' }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong>IMEI:</strong>
                        <div class="imei-code mt-1">{{ item.imei }}</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Purchase Date:</strong>
                            <br>
                            <small class="text-muted">
                                {{ item.purchase_date.strftime('%d/%m/%Y') if item.purchase_date else 'N/A' }}
                            </small>
                        </div>
                        <div class="col-6">
                            <strong>Purchase Price:</strong>
                            <br>
                            <small class="text-danger fw-bold">
                                {% if item.purchase.purchase_price %}
                                    PKR {{ "{:,}".format(item.purchase.purchase_price) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    {% if item.supplier %}
                    <div class="mb-3">
                        <strong>Supplier:</strong>
                        <br>
                        <small class="text-muted">{{ item.supplier.name }}</small>
                    </div>
                    {% endif %}
                    
                    {% if item.purchase.bill_number %}
                    <div class="mb-3">
                        <strong>Bill Number:</strong>
                        <br>
                        <span class="badge bg-secondary">{{ item.purchase.bill_number }}</span>
                    </div>
                    {% endif %}
                    
                    {% if item.sale %}
                    <div class="mb-3">
                        <strong>Sale Date:</strong>
                        <br>
                        <small class="text-muted">{{ item.sale_date.strftime('%d/%m/%Y') if item.sale_date else 'N/A' }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Sale Price:</strong>
                        <br>
                        <small class="text-success fw-bold">
                            {% if item.sale.sale_price %}
                                PKR {{ "{:,}".format(item.sale.sale_price) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Profit:</strong>
                        <br>
                        <span class="badge bg-success">
                            {% if session.get('profit_verified') and item.profit %}
                                PKR {{ "{:,}".format(item.profit) }}
                            {% else %}
                                Protected
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-footer">
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('search_device_result') }}?imei={{ item.imei }}" class="btn btn-sm btn-outline-primary" onclick="searchIMEI('{{ item.imei }}'); return false;">
                            <i class="fas fa-search"></i> Details
                        </a>
                        
                        {% if item.status == 'Available' %}
                        <a href="{{ url_for('sale_module') }}" class="btn btn-sm btn-success">
                            <i class="fas fa-shopping-cart"></i> Sell
                        </a>
                        {% endif %}
                        
                        {% if item.sale %}
                        <a href="{{ url_for('bill', sale_id=item.sale.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-file-invoice"></i> Bill
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Items Message -->
    {% if not inventory_items %}
    <div class="row">
        <div class="col-12 text-center py-5">
            <i class="fas fa-boxes text-muted" style="font-size: 4rem;"></i>
            <h4 class="text-muted mt-3">No inventory items found</h4>
            <p class="text-muted">Start by adding some devices to your inventory</p>
            <a href="{{ url_for('inventory_type') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add New Purchase
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
let currentStatusFilter = 'all';
let currentBrandFilter = '';

function filterByStatus(status) {
    currentStatusFilter = status;
    applyFilters();
}

function filterByBrand() {
    const brandSelect = document.getElementById('brand-select');
    currentBrandFilter = brandSelect.value;
    
    // Update brand cards selection
    document.querySelectorAll('.brand-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (currentBrandFilter) {
        const selectedCard = document.querySelector(`.brand-card[onclick="selectBrand('${currentBrandFilter}')"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
        updateBrandStats(currentBrandFilter);
    } else {
        clearBrandStats();
    }
    
    applyFilters();
}

function selectBrand(brandName) {
    const brandSelect = document.getElementById('brand-select');
    brandSelect.value = brandName;
    filterByBrand();
}

function toggleBrandFilter() {
    const brandSection = document.getElementById('brand-filter-section');
    if (brandSection.style.display === 'none') {
        brandSection.style.display = 'block';
    } else {
        brandSection.style.display = 'none';
        // Reset brand filter when hiding
        currentBrandFilter = '';
        document.getElementById('brand-select').value = '';
        document.querySelectorAll('.brand-card').forEach(card => {
            card.classList.remove('selected');
        });
        clearBrandStats();
        applyFilters();
    }
}

function applyFilters() {
    const items = document.querySelectorAll('.inventory-item');
    
    items.forEach(item => {
        const statusMatch = currentStatusFilter === 'all' || item.dataset.status === currentStatusFilter;
        const brandMatch = !currentBrandFilter || item.dataset.brand === currentBrandFilter;
        
        if (statusMatch && brandMatch) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
    
    updateVisibleCount();
}

function updateBrandStats(brandName) {
    const items = document.querySelectorAll(`[data-brand="${brandName}"]`);
    let total = items.length;
    let available = 0;
    let sold = 0;
    
    items.forEach(item => {
        if (item.dataset.status === 'Available') {
            available++;
        } else {
            sold++;
        }
    });
    
    const statsHtml = `
        <div class="stat-item">
            <strong>${brandName} Statistics</strong>
        </div>
        <div class="stat-item">
            <span>Total Devices:</span>
            <span class="fw-bold">${total}</span>
        </div>
        <div class="stat-item">
            <span>Available:</span>
            <span class="text-success fw-bold">${available}</span>
        </div>
        <div class="stat-item">
            <span>Sold:</span>
            <span class="text-danger fw-bold">${sold}</span>
        </div>
    `;
    
    document.getElementById('brand-stats').innerHTML = statsHtml;
}

function clearBrandStats() {
    document.getElementById('brand-stats').innerHTML = '<small class="text-muted">Select a brand to view statistics</small>';
}

function updateVisibleCount() {
    const visibleItems = document.querySelectorAll('.inventory-item[style*="block"], .inventory-item:not([style*="none"])').length;
    // You can add a counter display here if needed
}

function searchIMEI(imei) {
    try {
        // Create a form and submit it to search for the IMEI
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("search_device_result") }}';
        form.style.display = 'none'; // Hide the form
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'imei';
        input.value = imei;
        
        form.appendChild(input);
        document.body.appendChild(form);
        
        // Submit the form
        form.submit();
        
        // Clean up the form after submission
        setTimeout(() => {
            if (document.body.contains(form)) {
                document.body.removeChild(form);
            }
        }, 1000);
        
    } catch (error) {
        console.error('Error submitting IMEI search:', error);
        // Fallback: redirect with GET method
        window.location.href = '{{ url_for("search_device_result") }}?imei=' + encodeURIComponent(imei);
    }
}
</script>
{% endblock %} 